<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>å…±æœ‰ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ Admin Pro</title>
  <style>
    :root { --main: #007bff; --admin: #dc3545; --bg: #f8f9fa; --today: #e7f3ff; --accent: #ff9f43; --selected: #007bff; }
    body { font-family: sans-serif; background: var(--bg); margin: 0; padding: 10px; text-align: center; color: #333; }
    .card { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 15px; }
    input, textarea, button { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 16px; }
    .btn-submit { background: var(--main); color: white; border: none; font-weight: bold; cursor:pointer;}
    .btn-danger { background: var(--admin); color: white; border: none; font-size: 11px; padding: 4px 8px; width: auto; cursor:pointer; border-radius: 5px; }
    .btn-google { background: #fff; color: #757575; border: 1px solid #ddd; font-size: 11px; padding: 4px 8px; width: auto; cursor:pointer; border-radius: 5px; margin-right: 5px; display: inline-flex; align-items: center;}
    .hidden { display: none !important; }
    
    .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .cal-header button { width: auto; padding: 5px 15px; background: #eee; border: none; }
    .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #ddd; border: 1px solid #ddd; }
    .cal-label { background: #f0f0f0; font-size: 11px; padding: 5px 0; font-weight: bold; }
    .cal-day { background: white; min-height: 50px; font-size: 12px; padding: 2px; position: relative; display: flex; flex-direction: column; align-items: center; cursor: pointer; }
    .cal-day.today { background: var(--today); font-weight: bold; }
    .cal-day.selected { border: 2px solid var(--selected); background: #f0f7ff; }
    .has-task-mark { background: #ff4757; border-radius: 50%; width: 6px; height: 6px; margin-top: 4px; }
    
    .task { text-align: left; border-left: 5px solid var(--main); padding: 12px; background: #fff; margin-bottom: 10px; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); position: relative;}
    .task-date { font-size: 11px; color: var(--main); font-weight: bold; }
    .countdown-badge { position: absolute; top: 10px; right: 10px; background: var(--accent); color: white; font-size: 10px; padding: 3px 8px; border-radius: 20px; font-weight: bold;}
    .admin-only { border: 2px dashed var(--admin); padding: 10px; margin-top: 10px; border-radius: 10px; }
  </style>
</head>
<body>

  <div id="view-start">
    <h2>ğŸ« å…±æœ‰ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h2>
    <div id="sync-status" style="font-size:10px; color:#999; margin-bottom:10px;">æ¥ç¶šä¸­...</div>
    <div class="card">
      <input type="text" id="login-name" placeholder="å›£ä½“å">
      <input type="password" id="login-pass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
      <button class="btn-submit" onclick="loginAction(false)">ãƒ­ã‚°ã‚¤ãƒ³</button>
    </div>
    <button onclick="showView('view-setup')" style="background:none; border:none; text-decoration:underline; color:#666; font-size:14px;">æ–°è¦å›£ä½“ã‚’è¨­ç«‹ã™ã‚‹</button>
    <br><br>
    <button onclick="showView('view-admin-login')" style="font-size:12px; background:#eee; border:none; padding:5px; border-radius:5px;">ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</button>
  </div>

  <div id="view-setup" class="hidden">
    <h3>ğŸ—ï¸ å›£ä½“è¨­ç«‹</h3>
    <div class="card">
      <input type="text" id="setup-name" placeholder="æ–°ã—ã„å›£ä½“å">
      <input type="password" id="setup-gpass" placeholder="ãƒ¡ãƒ³ãƒãƒ¼ç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
      <input type="password" id="setup-opass" placeholder="ç®¡ç†è€…ç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
      <button class="btn-submit" onclick="createGroup()">è¨­ç«‹ã—ã¦ä¿å­˜</button>
    </div>
    <button onclick="showView('view-start')">æˆ»ã‚‹</button>
  </div>

  <div id="view-admin-login" class="hidden">
    <h3>âš™ï¸ ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</h3>
    <div class="card">
      <input type="text" id="admin-login-name" placeholder="å›£ä½“å">
      <input type="password" id="admin-login-pass" placeholder="ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
      <button class="btn-submit" onclick="loginAction(true)" style="background:var(--admin);">ç®¡ç†è€…ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³</button>
    </div>
    <button onclick="showView('view-start')">æˆ»ã‚‹</button>
  </div>

  <div id="view-calendar" class="hidden">
    <h3 id="group-title" style="margin: 10px 0 5px 0;"></h3>
    <div id="admin-mode-badge" class="hidden" style="color:red; font-size:11px; margin-bottom:10px;">
        ã€ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰ã€‘ <button onclick="showView('view-admin-settings')" style="width:auto; padding:2px 8px; font-size:10px;">âš™ï¸ ç®¡ç†è€…è¨­å®š</button>
    </div>
    
    <div class="card" style="padding: 10px;">
      <div class="cal-header">
        <button onclick="changeMonth(-1)">â—€</button>
        <b id="current-month-display"></b>
        <button onclick="changeMonth(1)">â–¶</button>
      </div>
      <div class="cal-grid" id="cal-grid"></div>
      <button id="btn-show-all" onclick="clearSelection()" style="margin-top:10px; font-size:12px; background:#eee; border:none; padding:8px; border-radius:5px; width:auto; display:none;">â† å…¨ã¦ã®äºˆå®šã‚’è¡¨ç¤º</button>
    </div>

    <div class="card">
      <h4 style="margin:0 0 10px 0; text-align:left; font-size:14px;">ğŸ“… äºˆå®šã‚’è¿½åŠ </h4>
      <input type="date" id="t-date">
      <input type="text" id="t-title" placeholder="äºˆå®šã®å†…å®¹">
      <input type="password" id="t-delpass" placeholder="å‰Šé™¤ç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
      <button class="btn-submit" onclick="addTask()">åŒæœŸã™ã‚‹</button>
    </div>

    <div id="task-list-title" style="text-align:left; font-weight:bold; margin: 10px 5px;">ã“ã‚Œã‹ã‚‰ã®äºˆå®š</div>
    <div id="task-list"></div>
    
    <button onclick="location.reload()" style="background:#666; color:white; margin-top:20px;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  </div>

  <div id="view-admin-settings" class="hidden">
    <h3>âš™ï¸ ç®¡ç†è€…è¨­å®š</h3>
    <div class="card admin-only">
      <h4>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å¤‰æ›´</h4>
      <label style="font-size:12px; display:block; text-align:left;">ãƒ¡ãƒ³ãƒãƒ¼ç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:</label>
      <input type="text" id="edit-gpass">
      <label style="font-size:12px; display:block; text-align:left;">ç®¡ç†è€…ç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:</label>
      <input type="text" id="edit-opass">
      <button class="btn-submit" onclick="updatePasswords()">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æ›´æ–°</button>
    </div>

    <div class="card admin-only" style="border-color: red;">
      <h4 style="color:red;">å›£ä½“ã®å‰Šé™¤</h4>
      <p style="font-size:11px;">ã“ã®å›£ä½“ã¨ã™ã¹ã¦ã®äºˆå®šã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã€‚å¾©æ´»ã¯ã§ãã¾ã›ã‚“ã€‚</p>
      <button class="btn-danger" style="width:100%; padding:12px;" onclick="deleteGroup()">å›£ä½“ã‚’å®Œå…¨ã«å‰Šé™¤ã™ã‚‹</button>
    </div>
    <button onclick="showView('view-calendar')">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«æˆ»ã‚‹</button>
  </div>

<script>
  const BIN_ID = "6989dd4bae596e708f1d842e";
  const API_KEY = "$2a$10$vOIMxpQkFmMIiTKTr5YlSuw1qB4Qrq3V7S51cnS9Q6b6v3K9rcKrK"; 

  let allData = {};
  let currentGroup = null;
  let isAdminMode = false;
  let displayDate = new Date();
  let selectedDateStr = null;

  async function syncFromCloud() {
    try {
      const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, { headers: { "X-Master-Key": API_KEY } });
      const json = await res.json();
      allData = json.record || {};
      document.getElementById('sync-status').innerText = "â— æ¥ç¶šæ¸ˆã¿";
    } catch (e) { document.getElementById('sync-status').innerText = "æ¥ç¶šã‚¨ãƒ©ãƒ¼"; }
  }

  async function syncToCloud() {
    await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
      method: 'PUT',
      headers: { "Content-Type": "application/json", "X-Master-Key": API_KEY },
      body: JSON.stringify(allData)
    });
  }

  async function createGroup() {
    const name = document.getElementById('setup-name').value;
    const gPass = document.getElementById('setup-gpass').value;
    const oPass = document.getElementById('setup-opass').value;
    if(!name || !gPass || !oPass) return alert("å…¨ã¦å…¥åŠ›ã—ã¦ãã ã•ã„");
    await syncFromCloud();
    if(allData[name]) return alert("ãã®åå‰ã¯æ—¢ã«ä½¿ã‚ã‚Œã¦ã„ã¾ã™");
    allData[name] = { name, gPass, oPass, tasks: [] };
    await syncToCloud();
    alert("è¨­ç«‹å®Œäº†ï¼");
    showView('view-start');
  }

  async function loginAction(isOpLogin) {
    const name = isOpLogin ? document.getElementById('admin-login-name').value : document.getElementById('login-name').value;
    const pass = isOpLogin ? document.getElementById('admin-login-pass').value : document.getElementById('login-pass').value;
    await syncFromCloud();
    const g = allData[name];
    if(g && (isOpLogin ? g.oPass === pass : g.gPass === pass)) {
      currentGroup = g;
      isAdminMode = isOpLogin;
      document.getElementById('group-title').innerText = name;
      document.getElementById('admin-mode-badge').className = isAdminMode ? "" : "hidden";
      // è¨­å®šç”»é¢ã®åˆæœŸå€¤ã‚’ã‚»ãƒƒãƒˆ
      document.getElementById('edit-gpass').value = g.gPass;
      document.getElementById('edit-opass').value = g.oPass;
      renderCalendar();
      showView('view-calendar');
    } else { alert("èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ"); }
  }

  // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ›´æ–°ï¼ˆç®¡ç†è€…ã®ã¿ï¼‰
  async function updatePasswords() {
    const newG = document.getElementById('edit-gpass').value;
    const newO = document.getElementById('edit-opass').value;
    if(!newG || !newO) return alert("ç©ºã«ã¯ã§ãã¾ã›ã‚“");
    await syncFromCloud();
    allData[currentGroup.name].gPass = newG;
    allData[currentGroup.name].oPass = newO;
    await syncToCloud();
    alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚æ¬¡å›ã‹ã‚‰æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");
    showView('view-calendar');
  }

  // å›£ä½“å‰Šé™¤ï¼ˆç®¡ç†è€…ã®ã¿ï¼‰
  async function deleteGroup() {
    if(!confirm("æœ¬å½“ã«ã“ã®å›£ä½“ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿãƒ‡ãƒ¼ã‚¿ã¯ã™ã¹ã¦æ¶ˆå»ã•ã‚Œã¾ã™ã€‚")) return;
    if(!confirm("æœ¬å½“ã®æœ¬å½“ã«ã„ã„ã§ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚")) return;
    await syncFromCloud();
    delete allData[currentGroup.name];
    await syncToCloud();
    alert("å›£ä½“ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚");
    location.reload();
  }

  async function addTask() {
    const title = document.getElementById('t-title').value;
    const date = document.getElementById('t-date').value;
    const delPass = document.getElementById('t-delpass').value || "0000";
    if(!title || !date) return alert("å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    await syncFromCloud();
    allData[currentGroup.name].tasks.push({ id: Date.now(), title, date, delPass });
    await syncToCloud();
    currentGroup = allData[currentGroup.name];
    renderCalendar();
    document.getElementById('t-title').value = "";
  }

  function getGoogleUrl(title, dateStr) {
    const d = dateStr.replace(/-/g, "");
    return `https://www.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title)}&dates=${d}/${d}`;
  }

  function getDiffDays(dateStr) {
    const target = new Date(dateStr);
    const today = new Date();
    today.setHours(0,0,0,0); target.setHours(0,0,0,0);
    return Math.ceil((target - today) / (1000 * 60 * 60 * 24));
  }

  async function deleteTask(taskId) {
    const task = currentGroup.tasks.find(t => t.id === taskId);
    if(!isAdminMode) {
      const p = prompt("å‰Šé™¤ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰");
      if(p !== task.delPass) return alert("ä¸ä¸€è‡´");
    }
    if(!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
    await syncFromCloud();
    allData[currentGroup.name].tasks = allData[currentGroup.name].tasks.filter(t => t.id !== taskId);
    await syncToCloud();
    currentGroup = allData[currentGroup.name];
    renderCalendar();
  }

  function selectDate(dStr) {
    selectedDateStr = dStr;
    document.getElementById('btn-show-all').style.display = "inline-block";
    document.getElementById('t-date').value = dStr;
    renderCalendar();
  }

  function clearSelection() {
    selectedDateStr = null;
    document.getElementById('btn-show-all').style.display = "none";
    renderCalendar();
  }

  function renderCalendar() {
    const year = displayDate.getFullYear();
    const month = displayDate.getMonth();
    document.getElementById('current-month-display').innerText = `${year}å¹´ ${month + 1}æœˆ`;
    const grid = document.getElementById('cal-grid');
    grid.innerHTML = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'].map(d => `<div class="cal-label">${d}</div>`).join('');
    const firstDay = new Date(year, month, 1).getDay();
    const lastDate = new Date(year, month + 1, 0).getDate();
    const today = new Date();
    for(let i=0; i<firstDay; i++) grid.innerHTML += `<div class="cal-day"></div>`;
    for(let i=1; i<=lastDate; i++) {
      const dStr = `${year}-${String(month+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
      const hasTask = currentGroup.tasks.some(t => t.date === dStr);
      const isT = today.getFullYear()===year && today.getMonth()===month && today.getDate()===i;
      const isS = selectedDateStr === dStr;
      grid.innerHTML += `<div class="cal-day ${isT?'today':''} ${isS?'selected':''}" onclick="selectDate('${dStr}')">${i}${hasTask?'<div class="has-task-mark"></div>':''}</div>`;
    }
    const list = document.getElementById('task-list');
    list.innerHTML = "";
    let tasksToShow = currentGroup.tasks;
    if (selectedDateStr) {
      document.getElementById('task-list-title').innerText = `${selectedDateStr} ã®äºˆå®š`;
      tasksToShow = tasksToShow.filter(t => t.date === selectedDateStr);
    } else {
      document.getElementById('task-list-title').innerText = "ã“ã‚Œã‹ã‚‰ã®äºˆå®š";
      tasksToShow = tasksToShow.filter(t => getDiffDays(t.date) >= 0);
    }
    tasksToShow.sort((a,b) => new Date(a.date) - new Date(b.date));
    if(tasksToShow.length === 0) list.innerHTML = "<p style='color:#999; font-size:12px;'>äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“</p>";
    tasksToShow.forEach(t => {
      const diff = getDiffDays(t.date);
      let diffText = diff === 0 ? "ä»Šæ—¥ï¼" : (diff < 0 ? "çµ‚äº†" : `ã‚ã¨ ${diff} æ—¥`);
      list.innerHTML += `<div class="task">
          <div class="countdown-badge ${diff<=3?'countdown-urgent':''}">${diffText}</div>
          <div class="task-date">${t.date}</div>
          <div style="margin: 5px 0;"><b>${t.title}</b></div>
          <div style="text-align:right;">
            <a href="${getGoogleUrl(t.title, t.date)}" target="_blank" class="btn-google">Googleé€£æº</a>
            <button class="btn-danger" onclick="deleteTask(${t.id})">å‰Šé™¤</button>
          </div>
        </div>`;
    });
  }

  function changeMonth(diff) {
    displayDate.setMonth(displayDate.getMonth() + diff);
    selectedDateStr = null;
    renderCalendar();
  }

  function showView(id) {
    document.querySelectorAll('body > div').forEach(v => v.classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
  }

  syncFromCloud();
</script>
</body>
</html>
