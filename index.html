<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>å…±æœ‰ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ Portal Final Rev3</title>
  <style>
    :root { --main: #007bff; --admin: #dc3545; --bg: #f8f9fa; --today: #e7f3ff; --accent: #ff9f43; --success: #28a745; --selected: #007bff; }
    body { font-family: sans-serif; background: var(--bg); margin: 0; padding: 0; text-align: center; color: #333; padding-bottom: 50px; }
    .card { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin: 10px; }
    input, button { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 16px; }
    .btn-submit { background: var(--main); color: white; border: none; font-weight: bold; cursor:pointer;}
    .btn-outline { background: white; color: var(--main); border: 1px solid var(--main); cursor:pointer;}
    .btn-danger { background: var(--admin); color: white; border: none; font-size: 11px; padding: 4px 8px; width: auto; border-radius: 5px; cursor:pointer; }
    .hidden { display: none !important; }
    
    .nav-bar { display: flex; justify-content: space-around; background: white; padding: 10px 0; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .nav-item { font-size: 12px; cursor: pointer; color: #666; font-weight: bold; flex: 1; }
    .nav-active { color: var(--main); border-bottom: 2px solid var(--main); }
    .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #ddd; border: 1px solid #ddd; }
    .cal-day { background: white; min-height: 50px; font-size: 12px; padding: 2px; position: relative; cursor: pointer; }
    .cal-day.today { background: var(--today); font-weight: bold; }
    .task { text-align: left; border-left: 5px solid var(--main); padding: 12px; background: #fff; margin: 10px; border-radius: 5px; position: relative; }
    .task.done { opacity: 0.6; border-left-color: var(--success); text-decoration: line-through; }
  </style>
</head>
<body>

  <div id="view-init">
    <h2 style="margin-top:50px;">ğŸ« ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒãƒ¼ã‚¿ãƒ«</h2>
    <div class="card">
      <button class="btn-submit" onclick="goToAuth(false)">å€‹äººã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§åˆ©ç”¨</button>
      <button class="btn-outline" onclick="showView('view-start')">ã‚²ã‚¹ãƒˆ / å›£ä½“ãƒ­ã‚°ã‚¤ãƒ³</button>
    </div>
  </div>

  <div id="view-user-auth" class="hidden">
    <h3>ğŸ‘¤ å€‹äººã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</h3>
    <div class="card">
      <p id="sync-notice" style="font-size:12px; color:var(--accent);" class="hidden">â€»ç¾åœ¨ã®å›£ä½“ã‚’ã‚ãªãŸã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ç™»éŒ²ã—ã¾ã™</p>
      <div style="display:flex; gap:5px;">
        <input type="text" id="user-acc-name" placeholder="ãŠåå‰">
        <button onclick="suggestName()" style="width:50px; background:#eee; border-radius:10px; border:1px solid #ddd;">âœ¨</button>
      </div>
      <input type="password" id="user-acc-pass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
      <button class="btn-submit" onclick="userLoginAction()">ãƒ­ã‚°ã‚¤ãƒ³ / ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ</button>
    </div>
    <button onclick="goBackFromUserAuth()">æˆ»ã‚‹</button>
  </div>

  <div id="view-portal" class="hidden">
    <div class="nav-bar">
      <div class="nav-item nav-active" onclick="renderPortal()">ğŸ  ç·åˆè¡¨</div>
      <div class="nav-item" onclick="showView('view-start')">ğŸ‘¥ å›£ä½“è¿½åŠ </div>
      <div class="nav-item" onclick="openMyPage()">ğŸ‘¤ è¨­å®š</div>
    </div>
    <h3 id="portal-user-name" style="margin:15px 0 5px;"></h3>
    <div id="total-task-list"></div>
    <button onclick="location.reload()" style="color:red; background:none; border:none; margin-top:30px; text-decoration:underline;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  </div>

  <div id="view-calendar" class="hidden">
    <h3 id="group-title" style="margin-bottom:5px;"></h3>
    <div id="admin-indicator" class="hidden" style="margin-bottom:10px;">
        <span style="color:red; font-size:12px; font-weight:bold;">ã€ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰ã€‘</span>
        <button onclick="openAdminSettings()" style="width:auto; padding:5px 10px; font-size:12px; background:#444; color:white; border-radius:5px; border:none;">âš™ï¸ å›£ä½“è¨­å®š</button>
    </div>
    <div id="user-status-bar" style="font-size:11px; margin-bottom:5px; color:#666;"></div>
    <div class="card"><div id="cal-grid" class="cal-grid"></div></div>
    <div class="card">
      <input type="date" id="t-date">
      <input type="text" id="t-title" placeholder="äºˆå®šã®å†…å®¹">
      <button class="btn-submit" onclick="addTask()">ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜</button>
    </div>
    <div id="task-list"></div>
    <button onclick="goBackFromCalendar()" class="btn-outline">æˆ»ã‚‹</button>
  </div>

  <div id="view-admin-settings" class="hidden">
    <h3>âš™ï¸ å›£ä½“ç®¡ç†</h3>
    <div class="card">
      <h4>ğŸ” å›£ä½“ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</h4>
      <input type="text" id="edit-gpass" placeholder="ãƒ¡ãƒ³ãƒãƒ¼ç”¨PW">
      <input type="text" id="edit-opass" placeholder="ç®¡ç†è€…ç”¨PW">
      <button class="btn-submit" onclick="updateGroupPasswords()">å›£ä½“PWã‚’æ›´æ–°</button>
    </div>
    <div id="admin-user-list-card" class="card">
      <h4>ğŸ‘¤ æ‰€å±ãƒ¦ãƒ¼ã‚¶ãƒ¼</h4>
      <div id="admin-user-list" style="text-align:left; font-size:13px;"></div>
    </div>
    <button class="btn-danger" style="margin:20px;" onclick="deleteGroup()">å›£ä½“ã‚’å®Œå…¨ã«å‰Šé™¤</button><br>
    <button onclick="showView('view-calendar')">æˆ»ã‚‹</button>
  </div>

  <div id="view-my-page" class="hidden">
    <h3>ğŸ‘¤ è¨­å®š</h3>
    <div class="card">
      <h4>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</h4>
      <input type="text" id="new-user-pass" placeholder="æ–°ã—ã„PW">
      <button class="btn-submit" onclick="changeMyPassword()">å¤‰æ›´ä¿å­˜</button>
    </div>
    <button class="btn-danger" style="margin:20px;" onclick="deleteMyAccount()">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤</button><br>
    <button onclick="showView('view-portal')">æˆ»ã‚‹</button>
  </div>

  <div id="view-start" class="hidden"><h3>å›£ä½“ãƒ­ã‚°ã‚¤ãƒ³</h3><div class="card"><input type="text" id="login-group-name" placeholder="å›£ä½“å"><input type="password" id="login-group-pass" placeholder="PW"><button class="btn-submit" onclick="groupLoginAction(false)">ãƒ¡ãƒ³ãƒãƒ¼ã¨ã—ã¦å…¥ã‚‹</button></div><button onclick="showView('view-setup')" style="color:var(--main); text-decoration:underline; background:none; border:none;">æ–°è¦å›£ä½“è¨­ç«‹</button> | <button onclick="showView('view-admin-login')" style="color:var(--admin); text-decoration:underline; background:none; border:none;">ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</button><br><button onclick="goBackFromGroupLogin()" style="margin-top:20px;">æˆ»ã‚‹</button></div>
  
  <div id="view-setup" class="hidden">
    <h3>å›£ä½“è¨­ç«‹</h3>
    <div class="card">
      <input type="text" id="s-n" placeholder="æ–°ã—ã„å›£ä½“å">
      <input type="password" id="s-g" placeholder="ãƒ¡ãƒ³ãƒãƒ¼ç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
      <input type="password" id="s-o" placeholder="ç®¡ç†è€…ç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
      <p style="font-size:11px; color:#666; text-align:left;">â€»ä¸¡æ–¹ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®šãŒå¿…é ˆã§ã™ã€‚</p>
      <button class="btn-submit" onclick="createGroup()">è¨­ç«‹ã—ã¦ä¿å­˜</button>
    </div>
    <button onclick="showView('view-start')">æˆ»ã‚‹</button>
  </div>

  <div id="view-admin-login" class="hidden"><h3>ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</h3><div class="card"><input type="text" id="al-n" placeholder="å›£ä½“å"><input type="password" id="al-p" placeholder="ç®¡ç†è€…PW"><button class="btn-submit" onclick="groupLoginAction(true)">ãƒ­ã‚°ã‚¤ãƒ³</button></div><button onclick="showView('view-start')">æˆ»ã‚‹</button></div>

<script>
  const BIN_ID = "6989dd4bae596e708f1d842e";
  const API_KEY = "$2a$10$vOIMxpQkFmMIiTKTr5YlSuw1qB4Qrq3V7S51cnS9Q6b6v3K9rcKrK"; 

  let allData = { groups: {}, globalUsers: {} };
  let currentGroup = null;
  let currentUser = null;
  let isAdminMode = false;
  let syncFlag = false;

  async function syncFromCloud() {
    try {
        const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, { headers: { "X-Master-Key": API_KEY } });
        const json = await res.json();
        allData = json.record || { groups: {}, globalUsers: {} };
    } catch(e) { console.error("Cloud Sync Error"); }
  }

  async function syncToCloud() {
    await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
      method: 'PUT',
      headers: { "Content-Type": "application/json", "X-Master-Key": API_KEY },
      body: JSON.stringify(allData)
    });
  }

  // â˜… å›£ä½“è¨­ç«‹æ™‚ã®ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½
  async function createGroup() {
    const name = document.getElementById('s-n').value.trim();
    const gPass = document.getElementById('s-g').value.trim();
    const oPass = document.getElementById('s-o').value.trim();

    if (!name) return alert("å›£ä½“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
    if (!gPass || !oPass) {
        return alert("ã€è­¦å‘Šã€‘ãƒ¡ãƒ³ãƒãƒ¼ç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¨ç®¡ç†è€…ç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ä¸¡æ–¹ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¿è­·ã®ãŸã‚ã€ç©ºã®ã¾ã¾ä½œæˆã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚");
    }

    await syncFromCloud();
    if (allData.groups[name]) return alert("ãã®å›£ä½“åã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚");

    allData.groups[name] = { 
        name: name, 
        gPass: gPass, 
        oPass: oPass, 
        tasks: [], 
        memberNames: [] 
    };
    await syncToCloud();
    alert("å›£ä½“ã‚’è¨­ç«‹ã—ã¾ã—ãŸï¼ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‹ã‚‰ãŠå…¥ã‚Šãã ã•ã„ã€‚");
    showView('view-start');
  }

  // --- ä»¥é™ã€æ—¢å­˜ã®å…¨æ©Ÿèƒ½ã‚’ç¶­æŒ ---
  function suggestName() {
    const adj = ["é’ã„", "å…ƒæ°—ãª", "ã®ã‚“ã³ã‚Š", "å…‰ã®", "ç©ºé£›ã¶", "ãƒŸãƒ©ã‚¯ãƒ«"];
    const noun = ["ãƒªã‚¹", "ã‚¹ã‚¿ãƒ¼", "ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼", "ãƒ©ã‚¤ã‚ªãƒ³", "ãƒãƒ¼ãƒˆ", "ãƒ©ãƒ³ãƒŠãƒ¼"];
    const res = adj[Math.floor(Math.random()*adj.length)] + noun[Math.floor(Math.random()*noun.length)] + (Math.floor(Math.random()*900)+100);
    document.getElementById('user-acc-name').value = res;
  }

  function goToAuth(isSync) {
    syncFlag = isSync;
    document.getElementById('sync-notice').className = syncFlag ? "" : "hidden";
    showView('view-user-auth');
  }

  async function userLoginAction() {
    const n = document.getElementById('user-acc-name').value;
    const p = document.getElementById('user-acc-pass').value;
    if(!n || !p) return alert("å…¥åŠ›ã—ã¦ä¸‹ã•ã„");
    await syncFromCloud();
    if(!allData.globalUsers[n]) {
      if(confirm("æ–°è¦ä½œæˆã—ã¾ã™ã‹ï¼Ÿ")) allData.globalUsers[n] = { name: n, pass: p, joinedGroups: [] };
      else return;
    } else if(allData.globalUsers[n].pass !== p) return alert("PWä¸ä¸€è‡´");
    currentUser = allData.globalUsers[n];
    if(syncFlag && currentGroup) {
      if(!currentUser.joinedGroups.includes(currentGroup.name)) {
        currentUser.joinedGroups.push(currentGroup.name);
        if(!allData.groups[currentGroup.name].memberNames) allData.groups[currentGroup.name].memberNames = [];
        allData.groups[currentGroup.name].memberNames.push(n);
      }
      syncFlag = false;
    }
    await syncToCloud();
    renderPortal();
    showView('view-portal');
  }

  async function groupLoginAction(isOp) {
    const gn = isOp ? document.getElementById('al-n').value : document.getElementById('login-group-name').value;
    const gp = isOp ? document.getElementById('al-p').value : document.getElementById('login-group-pass').value;
    await syncFromCloud();
    const g = allData.groups[gn];
    if(g && (isOp ? g.oPass === gp : g.gPass === gp)) {
      currentGroup = g; isAdminMode = isOp;
      if(currentUser && !currentUser.joinedGroups.includes(gn)) {
        currentUser.joinedGroups.push(gn);
        if(!g.memberNames) g.memberNames = [];
        if(!g.memberNames.includes(currentUser.name)) g.memberNames.push(currentUser.name);
        await syncToCloud();
      }
      renderCalendar(); showView('view-calendar');
    } else alert("èªè¨¼ã‚¨ãƒ©ãƒ¼");
  }

  function openAdminSettings() {
    document.getElementById('edit-gpass').value = currentGroup.gPass;
    document.getElementById('edit-opass').value = currentGroup.oPass;
    const list = document.getElementById('admin-user-list');
    list.innerHTML = (currentGroup.memberNames || []).map(m => `<div>ãƒ» ${m} (PW: ${allData.globalUsers[m]?.pass || '???'})</div>`).join('');
    showView('view-admin-settings');
  }

  async function updateGroupPasswords() {
    const gp = document.getElementById('edit-gpass').value;
    const op = document.getElementById('edit-opass').value;
    if(!gp || !op) return alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç©ºã«ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚");
    await syncFromCloud();
    allData.groups[currentGroup.name].gPass = gp;
    allData.groups[currentGroup.name].oPass = op;
    await syncToCloud();
    alert("æ›´æ–°ã—ã¾ã—ãŸ");
  }

  function renderCalendar() {
    document.getElementById('group-title').innerText = currentGroup.name;
    document.getElementById('admin-indicator').className = isAdminMode ? "" : "hidden";
    document.getElementById('user-status-bar').innerText = currentUser ? `ğŸ‘¤ ${currentUser.name}` : "ğŸ”“ ã‚²ã‚¹ãƒˆ";
    const grid = document.getElementById('cal-grid'); grid.innerHTML = "";
    for(let i=1; i<=31; i++) {
        const has = currentGroup.tasks.some(t => t.date.endsWith(String(i).padStart(2,'0')));
        grid.innerHTML += `<div class="cal-day">${i}${has?'<div style="background:red;width:5px;height:5px;border-radius:50%;margin:auto;"></div>':''}</div>`;
    }
    renderTaskList();
  }

  function renderTaskList() {
    const list = document.getElementById('task-list'); list.innerHTML = "";
    currentGroup.tasks.forEach(t => {
      const isD = JSON.parse(localStorage.getItem(`done_${currentUser?.name||'g'}`) || "[]").includes(String(t.id));
      list.innerHTML += `<div class="task ${isD?'done':''}" onclick="toggleDone('${t.id}')"><b>${t.title}</b><br><small>${t.date}</small></div>`;
    });
    if(!currentUser) list.innerHTML += `<button class="btn-outline" onclick="goToAuth(true)">ã“ã®å›£ä½“ã‚’ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«åŒæœŸ</button>`;
  }

  function renderPortal() {
    document.getElementById('portal-user-name').innerText = `${currentUser.name} ã•ã‚“ã®ãƒãƒ¼ã‚¿ãƒ«`;
    const list = document.getElementById('total-task-list'); list.innerHTML = "";
    let all = [];
    currentUser.joinedGroups.forEach(gn => { if(allData.groups[gn]) allData.groups[gn].tasks.forEach(t => all.push({...t, gn})); });
    all.sort((a,b)=>new Date(a.date)-new Date(b.date)).forEach(t => {
      const isD = JSON.parse(localStorage.getItem(`done_${currentUser.name}`) || "[]").includes(String(t.id));
      list.innerHTML += `<div class="task ${isD?'done':''}" onclick="toggleDone('${t.id}')"><b>[${t.gn}] ${t.title}</b><br><small>${t.date}</small></div>`;
    });
  }

  function toggleDone(id) {
    if(!currentUser) return alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™");
    let l = JSON.parse(localStorage.getItem(`done_${currentUser.name}`) || "[]");
    l = l.includes(id) ? l.filter(i=>i!==id) : [...l, id];
    localStorage.setItem(`done_${currentUser.name}`, JSON.stringify(l));
    if(!document.getElementById('view-portal').classList.contains('hidden')) renderPortal(); else renderCalendar();
  }

  async function addTask() {
    const t = document.getElementById('t-title').value, d = document.getElementById('t-date').value;
    if(!t || !d) return;
    await syncFromCloud();
    allData.groups[currentGroup.name].tasks.push({id: Date.now(), title: t, date: d});
    await syncToCloud(); renderCalendar();
  }

  async function deleteMyAccount() {
    if(!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
    const n = currentUser.name;
    await syncFromCloud();
    Object.values(allData.groups).forEach(g => { if(g.memberNames) g.memberNames = g.memberNames.filter(m => m !== n); });
    delete allData.globalUsers[n];
    await syncToCloud(); location.reload();
  }

  async function deleteGroup() {
    if(!confirm("å›£ä½“ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
    await syncFromCloud();
    delete allData.groups[currentGroup.name];
    await syncToCloud(); location.reload();
  }

  function goBackFromCalendar() { if(currentUser) { renderPortal(); showView('view-portal'); } else { showView('view-init'); } }
  function goBackFromUserAuth() { if(syncFlag) { showView('view-calendar'); } else { showView('view-init'); } }
  function goBackFromGroupLogin() { if(currentUser) { renderPortal(); showView('view-portal'); } else { showView('view-init'); } }
  function showView(id) { document.querySelectorAll('body > div').forEach(v => v.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); }
  function openMyPage() { showView('view-my-page'); }
  async function changeMyPassword() {
    const p = document.getElementById('new-user-pass').value;
    if(!p) return;
    await syncFromCloud(); allData.globalUsers[currentUser.name].pass = p; await syncToCloud(); alert("æ›´æ–°ã—ã¾ã—ãŸ");
  }

  syncFromCloud();
</script>
</body>
</html>
