<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>å…±æœ‰ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ Portal Pro</title>
  <style>
    :root { --main: #007bff; --admin: #dc3545; --bg: #f4f7f6; --today: #e7f3ff; --accent: #ff9f43; --success: #28a745; }
    body { font-family: sans-serif; background: var(--bg); margin: 0; padding: 10px; text-align: center; color: #333; }
    .card { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 15px; }
    input, button { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 16px; }
    .btn-submit { background: var(--main); color: white; border: none; font-weight: bold; cursor:pointer;}
    .btn-outline { background: white; color: var(--main); border: 1px solid var(--main); cursor:pointer;}
    .btn-danger { background: var(--admin); color: white; border: none; font-size: 11px; padding: 4px 8px; width: auto; cursor:pointer; border-radius: 5px; }
    .hidden { display: none !important; }
    
    /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ»ã‚¿ã‚¹ã‚¯ */
    .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #ddd; border: 1px solid #ddd; margin-bottom: 10px; }
    .cal-day { background: white; min-height: 40px; font-size: 11px; padding: 2px; cursor: pointer; }
    .task { text-align: left; border-left: 5px solid var(--main); padding: 10px; background: #fff; margin-bottom: 8px; border-radius: 5px; cursor: pointer; position: relative; }
    .task.done { opacity: 0.5; border-left-color: var(--success); text-decoration: line-through; }
    .group-tag { display: inline-block; font-size: 10px; background: #eee; padding: 2px 6px; border-radius: 4px; margin-bottom: 3px; }

    /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
    .nav-bar { display: flex; justify-content: space-around; background: white; padding: 10px; border-radius: 15px; margin-bottom: 15px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .nav-item { font-size: 12px; cursor: pointer; color: #666; font-weight: bold; }
    .nav-active { color: var(--main); }
  </style>
</head>
<body>

  <div id="view-init">
    <h2 style="margin-top:40px;">ğŸ« ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒãƒ¼ã‚¿ãƒ«</h2>
    <div class="card">
      <button class="btn-submit" onclick="showView('view-user-auth')">å€‹äººã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§åˆ©ç”¨</button>
      <button class="btn-outline" onclick="showView('view-start')">å›£ä½“ã‚²ã‚¹ãƒˆ/ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</button>
    </div>
  </div>

  <div id="view-user-auth" class="hidden">
    <h3>ğŸ‘¤ å€‹äººã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</h3>
    <div class="card">
      <input type="text" id="user-acc-name" placeholder="åå‰">
      <input type="password" id="user-acc-pass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ (ç”Ÿå¹´æœˆæ—¥ç­‰)">
      <button class="btn-submit" onclick="userLoginAction()">ãƒ­ã‚°ã‚¤ãƒ³ / æ–°è¦ä½œæˆ</button>
    </div>
    <button onclick="showView('view-init')">æˆ»ã‚‹</button>
  </div>

  <div id="view-portal" class="hidden">
    <div class="nav-bar">
      <div class="nav-item nav-active" onclick="renderPortal()">ğŸ  ç·åˆè¡¨</div>
      <div class="nav-item" onclick="showView('view-start')">ğŸ‘¥ å›£ä½“åˆ‡æ›¿</div>
      <div class="nav-item" onclick="showView('view-my-page')">ğŸ‘¤ ãƒã‚¤ãƒšãƒ¼ã‚¸</div>
    </div>
    <h3 id="portal-user-name"></h3>
    
    <div class="card">
      <h4 style="text-align:left; margin:0 0 10px 0;">ğŸ“… æ‰€å±å…¨å›£ä½“ã®ã‚¿ã‚¹ã‚¯</h4>
      <div id="total-task-list"></div>
    </div>
    <button onclick="logout()" style="color:red; background:none; border:none; text-decoration:underline;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  </div>

  <div id="view-my-page" class="hidden">
    <div class="nav-bar">
      <div class="nav-item" onclick="showView('view-portal')">ğŸ  ç·åˆè¡¨</div>
      <div class="nav-item" onclick="showView('view-start')">ğŸ‘¥ å›£ä½“åˆ‡æ›¿</div>
      <div class="nav-item nav-active" onclick="showView('view-my-page')">ğŸ‘¤ ãƒã‚¤ãƒšãƒ¼ã‚¸</div>
    </div>
    <h3>ğŸ‘¤ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®š</h3>
    <div class="card">
      <h4>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</h4>
      <input type="text" id="new-user-pass" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
      <button class="btn-submit" onclick="changeMyPassword()">ä¿å­˜ã™ã‚‹</button>
    </div>
    <div class="card">
      <h4>æ‰€å±ä¸­ã®å›£ä½“</h4>
      <div id="joined-groups-list" style="text-align:left; font-size:14px;"></div>
    </div>
    <button onclick="showView('view-portal')">æˆ»ã‚‹</button>
  </div>

  <div id="view-start" class="hidden">
    <h3>å›£ä½“ãƒ­ã‚°ã‚¤ãƒ³</h3>
    <div class="card">
      <input type="text" id="login-group-name" placeholder="å›£ä½“å">
      <input type="password" id="login-group-pass" placeholder="å›£ä½“ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
      <button class="btn-submit" onclick="groupLoginAction(false)">ã“ã®å›£ä½“ã«å…¥ã‚‹</button>
    </div>
    <button onclick="showView('view-setup')" style="font-size:12px;">æ–°è¦å›£ä½“è¨­ç«‹</button> | 
    <button onclick="showView('view-admin-login')" style="font-size:12px;">å›£ä½“ç®¡ç†è€…</button><br><br>
    <button onclick="showView(currentUser?'view-portal':'view-init')">æˆ»ã‚‹</button>
  </div>

  <div id="view-calendar" class="hidden">
    <h3 id="group-title"></h3>
    <div id="admin-mode-badge" class="hidden" style="color:red; font-size:11px;">ã€ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰ã€‘</div>
    <div class="card" style="padding:10px;"><div id="cal-grid" class="cal-grid"></div></div>
    <div class="card">
      <input type="date" id="t-date">
      <input type="text" id="t-title" placeholder="äºˆå®šå†…å®¹">
      <button class="btn-submit" onclick="addTask()">è¿½åŠ </button>
    </div>
    <div id="task-list"></div>
    <button onclick="showView('view-portal')" class="btn-outline">ãƒãƒ¼ã‚¿ãƒ«ã«æˆ»ã‚‹</button>
  </div>

  <div id="view-setup" class="hidden"><h3>å›£ä½“è¨­ç«‹</h3><div class="card"><input type="text" id="s-n" placeholder="å"><input type="password" id="s-g" placeholder="ãƒ¡"><input type="password" id="s-o" placeholder="ç®¡"><button onclick="createGroup()">è¨­ç«‹</button></div><button onclick="showView('view-start')">æˆ»ã‚‹</button></div>
  <div id="view-admin-login" class="hidden"><h3>ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</h3><div class="card"><input type="text" id="al-n" placeholder="å"><input type="password" id="al-p" placeholder="ãƒ‘ã‚¹"><button onclick="groupLoginAction(true)">ãƒ­ã‚°ã‚¤ãƒ³</button></div><button onclick="showView('view-start')">æˆ»ã‚‹</button></div>

<script>
  const BIN_ID = "6989dd4bae596e708f1d842e";
  const API_KEY = "$2a$10$vOIMxpQkFmMIiTKTr5YlSuw1qB4Qrq3V7S51cnS9Q6b6v3K9rcKrK"; 

  let allData = { groups: {}, globalUsers: {} };
  let currentGroup = null;
  let currentUser = null;
  let isAdminMode = false;

  async function syncFromCloud() {
    const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, { headers: { "X-Master-Key": API_KEY } });
    const json = await res.json();
    allData = json.record || { groups: {}, globalUsers: {} };
    if(!allData.groups) allData.groups = {};
    if(!allData.globalUsers) allData.globalUsers = {};
  }

  async function syncToCloud() {
    await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
      method: 'PUT',
      headers: { "Content-Type": "application/json", "X-Master-Key": API_KEY },
      body: JSON.stringify(allData)
    });
  }

  // å€‹äººãƒ­ã‚°ã‚¤ãƒ³
  async function userLoginAction() {
    const name = document.getElementById('user-acc-name').value;
    const pass = document.getElementById('user-acc-pass').value;
    await syncFromCloud();
    if(!allData.globalUsers[name]) {
        if(confirm("æ–°è¦ä½œæˆã—ã¾ã™ã‹ï¼Ÿ")) { allData.globalUsers[name] = { name, pass, joinedGroups: [] }; await syncToCloud(); } else return;
    } else if(allData.globalUsers[name].pass !== pass) return alert("ä¸ä¸€è‡´");
    
    currentUser = allData.globalUsers[name];
    renderPortal();
    showView('view-portal');
  }

  // ãƒãƒ¼ã‚¿ãƒ«ï¼ˆç·åˆè¡¨ï¼‰æç”»
  function renderPortal() {
    document.getElementById('portal-user-name').innerText = `ã‚ˆã†ã“ãã€${currentUser.name}ã•ã‚“`;
    const list = document.getElementById('total-task-list');
    list.innerHTML = "";
    
    let allTasks = [];
    (currentUser.joinedGroups || []).forEach(gName => {
        const g = allData.groups[gName];
        if(g) g.tasks.forEach(t => allTasks.push({ ...t, groupName: gName }));
    });
    
    allTasks.sort((a,b) => new Date(a.date) - new Date(b.date));
    if(allTasks.length === 0) list.innerHTML = "<p>æ‰€å±å›£ä½“ã«äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“</p>";
    
    allTasks.forEach(t => {
      const isDone = (JSON.parse(localStorage.getItem(`done_${currentUser.name}`) || "[]")).includes(t.id);
      list.innerHTML += `<div class="task ${isDone?'done':''}" onclick="toggleDone(${t.id})">
          <span class="group-tag">${t.groupName}</span><br>
          <small>${t.date}</small> <b>${t.title}</b>
      </div>`;
    });

    const gList = document.getElementById('joined-groups-list');
    gList.innerHTML = (currentUser.joinedGroups || []).map(g => `ãƒ» ${g}`).join('<br>');
  }

  // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´
  async function changeMyPassword() {
    const newPw = document.getElementById('new-user-pass').value;
    if(!newPw) return;
    await syncFromCloud();
    allData.globalUsers[currentUser.name].pass = newPw;
    await syncToCloud();
    alert("å¤‰æ›´ã—ã¾ã—ãŸ");
  }

  // å›£ä½“ãƒ­ã‚°ã‚¤ãƒ³
  async function groupLoginAction(isOp) {
    const gName = isOp ? document.getElementById('al-n').value : document.getElementById('login-group-name').value;
    const pass = isOp ? document.getElementById('al-p').value : document.getElementById('login-group-pass').value;
    await syncFromCloud();
    const g = allData.groups[gName];
    if(g && (isOp ? g.oPass === pass : g.gPass === pass)) {
      currentGroup = g; isAdminMode = isOp;
      if(currentUser && !currentUser.joinedGroups.includes(gName)) {
          currentUser.joinedGroups.push(gName);
          allData.globalUsers[currentUser.name].joinedGroups = currentUser.joinedGroups;
          await syncToCloud();
      }
      document.getElementById('group-title').innerText = gName;
      renderCalendar();
      showView('view-calendar');
    } else alert("é–“é•ã„");
  }

  function logout() { currentUser = null; currentGroup = null; showView('view-init'); }

  // ä»¥å‰ã®åŸºæœ¬æ©Ÿèƒ½
  async function addTask() {
    const title = document.getElementById('t-title').value, date = document.getElementById('t-date').value;
    await syncFromCloud();
    allData.groups[currentGroup.name].tasks.push({ id: Date.now(), title, date });
    await syncToCloud();
    renderCalendar();
  }

  function renderCalendar() {
    const grid = document.getElementById('cal-grid'); grid.innerHTML = "";
    const lastDate = new Date(2026, 2, 0).getDate(); // ç°¡æ˜“è¡¨ç¤º
    for(let i=1; i<=lastDate; i++) grid.innerHTML += `<div class="cal-day">${i}</div>`;
    const list = document.getElementById('task-list'); list.innerHTML = "";
    allData.groups[currentGroup.name].tasks.forEach(t => {
      list.innerHTML += `<div class="task" onclick="toggleDone(${t.id})"><small>${t.date}</small> <b>${t.title}</b></div>`;
    });
  }

  function toggleDone(taskId) {
    if(!currentUser) return;
    let done = JSON.parse(localStorage.getItem(`done_${currentUser.name}`) || "[]");
    done = done.includes(taskId) ? done.filter(id => id !== taskId) : [...done, taskId];
    localStorage.setItem(`done_${currentUser.name}`, JSON.stringify(done));
    if(document.getElementById('view-portal').classList.contains('hidden')) renderCalendar(); else renderPortal();
  }

  async function createGroup() {
    const n = document.getElementById('s-n').value;
    await syncFromCloud();
    allData.groups[n] = { name:n, gPass:document.getElementById('s-g').value, oPass:document.getElementById('s-o').value, tasks:[] };
    await syncToCloud();
    showView('view-start');
  }

  function showView(id) { document.querySelectorAll('body > div').forEach(v => v.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); }
  syncFromCloud();
</script>
</body>
</html>
