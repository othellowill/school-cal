<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>å…±æœ‰ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ Portal Expert</title>
  <style>
    :root { --main: #007bff; --admin: #dc3545; --bg: #f8f9fa; --today: #e7f3ff; --accent: #ff9f43; --success: #28a745; --selected: #007bff; }
    body { font-family: sans-serif; background: var(--bg); margin: 0; padding: 0; text-align: center; color: #333; padding-bottom: 50px; }
    .card { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin: 10px; }
    input, button { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 16px; }
    .btn-submit { background: var(--main); color: white; border: none; font-weight: bold; cursor:pointer;}
    .btn-outline { background: white; color: var(--main); border: 1px solid var(--main); cursor:pointer;}
    .btn-danger { background: var(--admin); color: white; border: none; font-size: 11px; padding: 4px 8px; width: auto; border-radius: 5px; cursor:pointer; }
    .hidden { display: none !important; }
    
    /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
    .nav-bar { display: flex; justify-content: space-around; background: white; padding: 10px 0; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .nav-item { font-size: 12px; cursor: pointer; color: #666; font-weight: bold; flex: 1; }
    .nav-active { color: var(--main); border-bottom: 2px solid var(--main); }

    /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */
    .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .cal-header button { width: auto; padding: 5px 15px; background: #eee; border: none; }
    .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #ddd; border: 1px solid #ddd; }
    .cal-label { background: #f0f0f0; font-size: 11px; padding: 5px 0; font-weight: bold; }
    .cal-day { background: white; min-height: 50px; font-size: 12px; padding: 2px; position: relative; display: flex; flex-direction: column; align-items: center; cursor: pointer; }
    .cal-day.today { background: var(--today); font-weight: bold; }
    .cal-day.selected { border: 2px solid var(--selected); background: #f0f7ff; z-index: 5; box-sizing: border-box; }
    .mark { background: #ff4757; border-radius: 50%; width: 6px; height: 6px; margin-top: 4px; }
    
    /* ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆãƒ»ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ */
    .task { text-align: left; border-left: 5px solid var(--main); padding: 12px; background: #fff; margin: 10px; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); position: relative; transition: 0.2s; }
    .task.done { opacity: 0.6; border-left-color: var(--success); background: #f0fdf4; }
    .task.done b { text-decoration: line-through; color: #888; }
    .check-mark { position: absolute; top: 10px; right: 10px; font-weight: bold; color: var(--success); font-size: 14px; }
    .group-tag { font-size: 10px; background: #eee; padding: 2px 5px; border-radius: 3px; color: #666; margin-bottom: 4px; display: inline-block; }
    .countdown { font-size: 10px; color: var(--accent); font-weight: bold; margin-bottom: 2px; }
  </style>
</head>
<body>

  <div id="view-init">
    <h2 style="margin-top:50px;">ğŸ« ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒãƒ¼ã‚¿ãƒ«</h2>
    <div class="card">
      <button class="btn-submit" onclick="showView('view-user-auth')">å€‹äººã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³</button>
      <button class="btn-outline" onclick="showView('view-start')">å›£ä½“ã‚²ã‚¹ãƒˆ / ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</button>
    </div>
  </div>

  <div id="view-user-auth" class="hidden">
    <h3>ğŸ‘¤ å€‹äººã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</h3>
    <div class="card">
      <input type="text" id="user-acc-name" placeholder="ãŠåå‰">
      <input type="password" id="user-acc-pass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰(ç”Ÿå¹´æœˆæ—¥ãªã©)">
      <button class="btn-submit" onclick="userLoginAction()">ãƒ­ã‚°ã‚¤ãƒ³ / ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ</button>
    </div>
    <button onclick="showView('view-init')">æˆ»ã‚‹</button>
  </div>

  <div id="view-portal" class="hidden">
    <div class="nav-bar">
      <div id="nav-home" class="nav-item nav-active" onclick="renderPortal()">ğŸ  ç·åˆè¡¨</div>
      <div id="nav-switch" class="nav-item" onclick="showView('view-start')">ğŸ‘¥ å›£ä½“åˆ‡æ›¿</div>
      <div id="nav-me" class="nav-item" onclick="openMyPage()">ğŸ‘¤ ãƒã‚¤ãƒšãƒ¼ã‚¸</div>
    </div>
    <h3 id="portal-user-name" style="margin:15px 0 5px;"></h3>
    <p style="font-size:12px; color:#666;">ã‚¿ãƒƒãƒ—ã—ã¦ã‚¿ã‚¹ã‚¯ã‚’å®Œäº†/æœªå®Œäº†ã«ã§ãã¾ã™</p>
    <div id="total-task-list"></div>
    <button onclick="logout()" style="color:red; background:none; border:none; margin-top:30px; text-decoration:underline;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  </div>

  <div id="view-start" class="hidden">
    <h3>å›£ä½“ãƒ­ã‚°ã‚¤ãƒ³</h3>
    <div class="card">
      <input type="text" id="login-group-name" placeholder="å›£ä½“å">
      <input type="password" id="login-group-pass" placeholder="å›£ä½“ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
      <button class="btn-submit" onclick="groupLoginAction(false)">ã“ã®å›£ä½“ã«å…¥ã‚‹</button>
    </div>
    <div style="font-size:12px;">
        <button onclick="showView('view-setup')" style="width:auto; background:none; border:none; text-decoration:underline; color:#007bff;">æ–°è¦å›£ä½“ã‚’è¨­ç«‹</button> | 
        <button onclick="showView('view-admin-login')" style="width:auto; background:none; border:none; text-decoration:underline; color:#dc3545;">å›£ä½“ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</button>
    </div>
    <button onclick="goBackFromGroupLogin()" style="margin-top:20px;">æˆ»ã‚‹</button>
  </div>

  <div id="view-calendar" class="hidden">
    <h3 id="group-title" style="margin:10px 0 0;"></h3>
    <div id="admin-badge" class="hidden" style="color:red; font-size:11px; margin-bottom:5px;">
        ã€ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰ã€‘ <button onclick="openAdminSettings()" style="width:auto; padding:2px 8px; font-size:10px;">âš™ï¸ å›£ä½“ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</button>
    </div>
    <div class="card">
      <div class="cal-header">
        <button onclick="changeMonth(-1)">â—€</button>
        <b id="cal-month-display"></b>
        <button onclick="changeMonth(1)">â–¶</button>
      </div>
      <div id="cal-grid" class="cal-grid"></div>
      <button id="btn-show-all" class="hidden" onclick="clearSelection()" style="margin-top:10px; font-size:11px; border:none; background:#eee; padding:5px; border-radius:5px;">â† å…¨è¡¨ç¤ºã«æˆ»ã™</button>
    </div>
    <div class="card">
      <h4 style="margin:0 0 5px; text-align:left; font-size:14px;">â• æ–°ã—ã„äºˆå®š</h4>
      <input type="date" id="t-date">
      <input type="text" id="t-title" placeholder="äºˆå®šã®å†…å®¹ (ä¾‹: 13:00ã€œ ä¼šè­°)">
      <button class="btn-submit" onclick="addTask()">ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜</button>
    </div>
    <div id="task-list"></div>
    <button onclick="showView('view-portal')" class="btn-outline">ãƒãƒ¼ã‚¿ãƒ«ã¸æˆ»ã‚‹</button>
  </div>

  <div id="view-my-page" class="hidden">
    <h3>ğŸ‘¤ ãƒã‚¤ãƒšãƒ¼ã‚¸</h3>
    <div class="card">
      <h4>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</h4>
      <input type="text" id="new-user-pass" placeholder="æ–°ã—ã„å€‹äººãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
      <button class="btn-submit" onclick="changeMyPassword()">å¤‰æ›´ã‚’ä¿å­˜</button>
    </div>
    <div class="card" style="text-align:left;">
      <h4>æ‰€å±ä¸­ã®å›£ä½“</h4>
      <div id="my-groups-list"></div>
    </div>
    <button onclick="showView('view-portal')">æˆ»ã‚‹</button>
  </div>

  <div id="view-admin-settings" class="hidden">
    <h3>âš™ï¸ å›£ä½“ç®¡ç†è€…è¨­å®š</h3>
    <div class="card">
      <h4>ğŸ” å›£ä½“ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</h4>
      <label style="font-size:11px; display:block; text-align:left;">ãƒ¡ãƒ³ãƒãƒ¼ç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:</label>
      <input type="text" id="edit-gpass">
      <label style="font-size:11px; display:block; text-align:left;">ç®¡ç†è€…ç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:</label>
      <input type="text" id="edit-opass">
      <button class="btn-submit" onclick="updateGroupPasswords()">å›£ä½“ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æ›´æ–°</button>
    </div>
    <div class="card">
      <h4>ğŸ‘¤ å‚åŠ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç† (ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¼·åˆ¶å¤‰æ›´)</h4>
      <div id="admin-user-list" style="text-align:left; font-size:13px;"></div>
    </div>
    <div class="card" style="border:1px solid red;">
      <h4 style="color:red;">å›£ä½“ã®æ¶ˆå»</h4>
      <button class="btn-danger" style="width:100%; padding:10px;" onclick="deleteGroup()">ã“ã®å›£ä½“ã‚’å®Œå…¨ã«å‰Šé™¤</button>
    </div>
    <button onclick="showView('view-calendar')">æˆ»ã‚‹</button>
  </div>

  <div id="view-setup" class="hidden"><h3>å›£ä½“è¨­ç«‹</h3><div class="card"><input type="text" id="s-n" placeholder="æ–°ã—ã„å›£ä½“å"><input type="password" id="s-g" placeholder="ãƒ¡ãƒ³ãƒãƒ¼ç”¨PW"><input type="password" id="s-o" placeholder="ç®¡ç†è€…ç”¨PW"><button class="btn-submit" onclick="createGroup()">è¨­ç«‹ã—ã¦ä¿å­˜</button></div><button onclick="showView('view-start')">æˆ»ã‚‹</button></div>
  <div id="view-admin-login" class="hidden"><h3>å›£ä½“ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</h3><div class="card"><input type="text" id="al-n" placeholder="å›£ä½“å"><input type="password" id="al-p" placeholder="ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"><button class="btn-submit" onclick="groupLoginAction(true)">ç®¡ç†è€…ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³</button></div><button onclick="showView('view-start')">æˆ»ã‚‹</button></div>

<script>
  const BIN_ID = "6989dd4bae596e708f1d842e";
  const API_KEY = "$2a$10$vOIMxpQkFmMIiTKTr5YlSuw1qB4Qrq3V7S51cnS9Q6b6v3K9rcKrK"; 

  let allData = { groups: {}, globalUsers: {} };
  let currentGroup = null;
  let currentUser = null;
  let isAdminMode = false;
  let displayDate = new Date();
  let selectedDateStr = null;

  async function syncFromCloud() {
    try {
      const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, { headers: { "X-Master-Key": API_KEY } });
      const json = await res.json();
      allData = json.record || { groups: {}, globalUsers: {} };
      if(!allData.groups) allData.groups = {};
      if(!allData.globalUsers) allData.globalUsers = {};
    } catch(e) { console.error("Cloud Error"); }
  }

  async function syncToCloud() {
    await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
      method: 'PUT',
      headers: { "Content-Type": "application/json", "X-Master-Key": API_KEY },
      body: JSON.stringify(allData)
    });
  }

  // å€‹äººã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‡¦ç†
  async function userLoginAction() {
    const name = document.getElementById('user-acc-name').value;
    const pass = document.getElementById('user-acc-pass').value;
    if(!name || !pass) return alert("å…¥åŠ›ã—ã¦ãã ã•ã„");
    await syncFromCloud();
    if(!allData.globalUsers[name]) {
      if(confirm("ã“ã®åå‰ã§æ–°ã—ãç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ")) {
        allData.globalUsers[name] = { name, pass, joinedGroups: [] };
        await syncToCloud();
      } else return;
    } else if(allData.globalUsers[name].pass !== pass) return alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™");
    currentUser = allData.globalUsers[name];
    renderPortal();
    showView('view-portal');
  }

  // å›£ä½“ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
  async function groupLoginAction(isOp) {
    const gn = isOp ? document.getElementById('al-n').value : document.getElementById('login-group-name').value;
    const gp = isOp ? document.getElementById('al-p').value : document.getElementById('login-group-pass').value;
    await syncFromCloud();
    const g = allData.groups[gn];
    if(g && (isOp ? g.oPass === gp : g.gPass === gp)) {
      currentGroup = g; isAdminMode = isOp;
      if(currentUser && !currentUser.joinedGroups.includes(gn)) {
        currentUser.joinedGroups.push(gn);
        allData.globalUsers[currentUser.name].joinedGroups = currentUser.joinedGroups;
        if(!g.memberNames) g.memberNames = [];
        if(!g.memberNames.includes(currentUser.name)) g.memberNames.push(currentUser.name);
        await syncToCloud();
      }
      document.getElementById('group-title').innerText = gn;
      document.getElementById('admin-badge').className = isOp ? "" : "hidden";
      renderCalendar();
      showView('view-calendar');
    } else alert("å›£ä½“åã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™");
  }

  // å›£ä½“ç®¡ç†ï¼šãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ›´æ–°
  async function updateGroupPasswords() {
    const newG = document.getElementById('edit-gpass').value;
    const newO = document.getElementById('edit-opass').value;
    if(!newG || !newO) return alert("ç©ºã«ã¯ã§ãã¾ã›ã‚“");
    await syncFromCloud();
    allData.groups[currentGroup.name].gPass = newG;
    allData.groups[currentGroup.name].oPass = newO;
    await syncToCloud();
    alert("å›£ä½“ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æ›´æ–°ã—ã¾ã—ãŸ");
  }

  // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”»
  function renderCalendar() {
    const year = displayDate.getFullYear(), month = displayDate.getMonth();
    document.getElementById('cal-month-display').innerText = `${year}å¹´ ${month + 1}æœˆ`;
    const grid = document.getElementById('cal-grid');
    grid.innerHTML = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'].map(d => `<div class="cal-label">${d}</div>`).join('');
    const firstDay = new Date(year, month, 1).getDay();
    const lastDate = new Date(year, month + 1, 0).getDate();
    for(let i=0; i<firstDay; i++) grid.innerHTML += `<div></div>`;
    for(let i=1; i<=lastDate; i++) {
      const dStr = `${year}-${String(month+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
      const hasT = currentGroup.tasks.some(t => t.date === dStr);
      const isToday = new Date().toLocaleDateString('sv') === dStr;
      grid.innerHTML += `<div class="cal-day ${isToday?'today':''} ${selectedDateStr===dStr?'selected':''}" onclick="selectDate('${dStr}')">${i}${hasT?'<div class="mark"></div>':''}</div>`;
    }
    renderTaskList();
  }

  function renderTaskList() {
    const list = document.getElementById('task-list');
    list.innerHTML = "";
    let tasks = currentGroup.tasks.filter(t => selectedDateStr ? t.date === selectedDateStr : getDiff(t.date) >= 0);
    tasks.sort((a,b) => new Date(a.date) - new Date(b.date));
    tasks.forEach(t => {
      const isDone = getDoneList().includes(String(t.id));
      list.innerHTML += `<div class="task ${isDone?'done':''}" onclick="toggleDone('${t.id}')">
        ${isDone?'<div class="check-mark">âœ“</div>':''}
        <div class="countdown">ã‚ã¨ ${getDiff(t.date)} æ—¥</div>
        <small>${t.date}</small><br><b>${t.title}</b>
      </div>`;
    });
  }

  // ç·åˆãƒãƒ¼ã‚¿ãƒ«æç”»
  function renderPortal() {
    document.getElementById('portal-user-name').innerText = `ğŸ‘¤ ${currentUser.name} ã•ã‚“ã®äºˆå®š`;
    const list = document.getElementById('total-task-list');
    list.innerHTML = "";
    let allTasks = [];
    (currentUser.joinedGroups || []).forEach(gn => {
      if(allData.groups[gn]) allData.groups[gn].tasks.forEach(t => allTasks.push({...t, gn}));
    });
    allTasks = allTasks.filter(t => getDiff(t.date) >= 0).sort((a,b) => new Date(a.date) - new Date(b.date));
    if(allTasks.length === 0) list.innerHTML = "<p style='color:#999;'>äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“</p>";
    allTasks.forEach(t => {
      const isDone = getDoneList().includes(String(t.id));
      list.innerHTML += `<div class="task ${isDone?'done':''}" onclick="toggleDone('${t.id}')">
        ${isDone?'<div class="check-mark">âœ“</div>':''}
        <span class="group-tag">${t.gn}</span><br>
        <small>${t.date}</small> <b>${t.title}</b>
      </div>`;
    });
    showView('view-portal');
  }

  // ç®¡ç†è€…è¨­å®šã‚ªãƒ¼ãƒ—ãƒ³
  function openAdminSettings() {
    document.getElementById('edit-gpass').value = currentGroup.gPass;
    document.getElementById('edit-opass').value = currentGroup.oPass;
    const list = document.getElementById('admin-user-list');
    list.innerHTML = "";
    (currentGroup.memberNames || []).forEach(m => {
      const u = allData.globalUsers[m];
      if(!u) return;
      list.innerHTML += `<div style="margin-bottom:10px;">
        <b>${m}</b>: <input type="text" id="apw-${m}" value="${u.pass}" style="width:100px; padding:2px; font-size:12px;"> 
        <button class="btn-submit" style="width:auto; padding:3px 8px; font-size:11px;" onclick="adminChangePw('${m}')">PWå¤‰æ›´</button>
      </div>`;
    });
    showView('view-admin-settings');
  }

  // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
  function getDiff(d) {
    const diff = new Date(d) - new Date().setHours(0,0,0,0);
    return Math.ceil(diff / 86400000);
  }
  function getDoneList() { return JSON.parse(localStorage.getItem(`done_${currentUser?.name || 'guest'}`) || "[]"); }
  function toggleDone(id) {
    if(!currentUser) return alert("ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½ã¯å€‹äººãƒ­ã‚°ã‚¤ãƒ³æ™‚ã®ã¿æœ‰åŠ¹ã§ã™");
    let list = getDoneList().map(i => String(i));
    list = list.includes(id) ? list.filter(i => i !== id) : [...list, id];
    localStorage.setItem(`done_${currentUser.name}`, JSON.stringify(list));
    if(!document.getElementById('view-portal').classList.contains('hidden')) renderPortal(); else renderCalendar();
  }
  function selectDate(d) { selectedDateStr = d; document.getElementById('btn-show-all').classList.remove('hidden'); renderCalendar(); }
  function clearSelection() { selectedDateStr = null; document.getElementById('btn-show-all').classList.add('hidden'); renderCalendar(); }
  function changeMonth(n) { displayDate.setMonth(displayDate.getMonth() + n); clearSelection(); }
  async function addTask() {
    const t = document.getElementById('t-title').value, d = document.getElementById('t-date').value;
    if(!t || !d) return alert("å†…å®¹ã¨æ—¥ä»˜ã‚’å…¥ã‚Œã¦ãã ã•ã„");
    await syncFromCloud();
    allData.groups[currentGroup.name].tasks.push({id: Date.now(), title: t, date: d});
    await syncToCloud(); renderCalendar();
    document.getElementById('t-title').value = "";
  }
  async function createGroup() {
    const n = document.getElementById('s-n').value;
    if(!n) return;
    await syncFromCloud();
    allData.groups[n] = {name:n, gPass:document.getElementById('s-g').value, oPass:document.getElementById('s-o').value, tasks:[], memberNames:[]};
    await syncToCloud(); alert("å›£ä½“ã‚’è¨­ç«‹ã—ã¾ã—ãŸ"); showView('view-start');
  }
  async function adminChangePw(m) {
    const newPw = document.getElementById(`apw-${m}`).value;
    await syncFromCloud(); allData.globalUsers[m].pass = newPw; await syncToCloud(); alert("ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸ");
  }
  async function deleteGroup() {
    if(!confirm("æœ¬å½“ã«ã“ã®å›£ä½“ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
    await syncFromCloud(); delete allData.groups[currentGroup.name]; await syncToCloud(); location.reload();
  }
  function logout() { location.reload(); }
  function goBackFromGroupLogin() { showView(currentUser ? 'view-portal' : 'view-init'); }
  function openMyPage() {
    const list = document.getElementById('my-groups-list');
    list.innerHTML = (currentUser.joinedGroups || []).map(g => `ãƒ» ${g}`).join('<br>');
    showView('view-my-page');
  }
  async function changeMyPassword() {
    const p = document.getElementById('new-user-pass').value;
    if(!p) return;
    await syncFromCloud(); allData.globalUsers[currentUser.name].pass = p; await syncToCloud(); alert("ãƒã‚¤ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æ›´æ–°ã—ã¾ã—ãŸ");
  }
  function showView(id) {
    document.querySelectorAll('body > div').forEach(v => v.classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('nav-active'));
    if(id==='view-portal') document.getElementById('nav-home').classList.add('nav-active');
  }
  syncFromCloud();
</script>
</body>
</html>
