<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root { --main: #007bff; --admin: #dc3545; --bg: #f8f9fa; }
    body { font-family: sans-serif; background: var(--bg); margin: 0; padding: 15px; text-align: center; }
    .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
    input, textarea, button { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 16px; }
    .btn-submit { background: var(--main); color: white; border: none; font-weight: bold; cursor:pointer;}
    .btn-danger { background: var(--admin); color: white; border: none; font-size: 12px; padding: 5px; width: auto; cursor:pointer; }
    .hidden { display: none !important; }
    .cal-wrapper { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; margin: 10px 0; border: 1px solid #ddd; background: #ddd; }
    .cal-label { background: #eee; font-size: 10px; padding: 5px 0; font-weight: bold; }
    .cal-day { background: white; height: 45px; font-size: 10px; padding: 2px; position: relative; }
    .has-task-mark { background: #ffeb3b; border-radius: 50%; width: 6px; height: 6px; position: absolute; bottom: 5px; left: 50%; transform: translateX(-50%); }
    .task { text-align: left; border-left: 5px solid var(--main); padding: 10px; background: #fff; margin-bottom: 10px; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
  </style>
</head>
<body>
  <div id="view-start">
    <h2>ğŸ« å…±æœ‰ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h2>
    <div id="sync-status" style="font-size:10px; color:#999;">ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸæº–å‚™ä¸­...</div>
    <input type="text" id="login-name" placeholder="å›£ä½“å">
    <input type="password" id="login-pass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
    <button class="btn-submit" onclick="loginAction(false)">ãƒ­ã‚°ã‚¤ãƒ³</button>
    <hr>
    <button onclick="showView('view-setup')" style="background:none; border:none; text-decoration:underline; color:#666; font-size:14px;">æ–°è¦å›£ä½“ã‚’è¨­ç«‹ã™ã‚‹</button>
  </div>

  <div id="view-setup" class="hidden">
    <h3>ğŸ—ï¸ å›£ä½“è¨­ç«‹</h3>
    <input type="text" id="setup-name" placeholder="æ–°ã—ã„å›£ä½“å">
    <input type="password" id="setup-gpass" placeholder="ãƒ¡ãƒ³ãƒãƒ¼ç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
    <input type="password" id="setup-opass" placeholder="ç®¡ç†è€…ç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
    <button class="btn-submit" onclick="createGroup()">ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜ã—ã¦è¨­ç«‹</button>
    <button onclick="showView('view-start')">æˆ»ã‚‹</button>
  </div>

  <div id="view-calendar" class="hidden">
    <h3 id="group-title" style="margin-bottom:5px;"></h3>
    <div class="card">
      <h4 style="margin:0; text-align:left; font-size:14px;">äºˆå®šã‚’è¿½åŠ </h4>
      <input type="date" id="t-date">
      <input type="text" id="t-title" placeholder="ã‚¿ã‚¤ãƒˆãƒ«">
      <input type="password" id="t-delpass" placeholder="å‰Šé™¤ç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
      <button class="btn-submit" onclick="addTask()">è¿½åŠ ã—ã¦å…¨å“¡ã«åŒæœŸ</button>
    </div>
    <div class="card" style="padding:10px;"><div class="cal-wrapper" id="cal-grid"></div></div>
    <div id="task-list"></div>
    <button onclick="location.reload()" style="background:#666; color:white;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  </div>

<script>
  // ã‚¯ãƒ©ã‚¦ãƒ‰æ¥ç¶šæƒ…å ±
  const BIN_ID = "6989dd4bae596e708f1d842e";
  const API_KEY = "$2a$10$vOIMxpQkFmMIiTKTr5YlSuw1qB4Qrq3V7S51cnS9Q6b6v3K9rcKrK"; 

  let allData = {};
  let currentGroup = null;

  async function syncFromCloud() {
    try {
      const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
        headers: { "X-Master-Key": API_KEY }
      });
      const json = await res.json();
      allData = json.record || {};
      document.getElementById('sync-status').innerText = "â— ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸæ¸ˆã¿";
    } catch (e) {
      document.getElementById('sync-status').innerText = "åŒæœŸã‚¨ãƒ©ãƒ¼";
    }
  }

  async function syncToCloud() {
    await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
      method: 'PUT',
      headers: { "Content-Type": "application/json", "X-Master-Key": API_KEY },
      body: JSON.stringify(allData)
    });
  }

  async function createGroup() {
    const name = document.getElementById('setup-name').value;
    const gPass = document.getElementById('setup-gpass').value;
    const oPass = document.getElementById('setup-opass').value;
    if(!name || !gPass || !oPass) return alert("å…¨ã¦å…¥åŠ›ã—ã¦ãã ã•ã„");
    await syncFromCloud();
    allData[name] = { name, gPass, oPass, tasks: [] };
    await syncToCloud();
    alert("è¨­ç«‹å®Œäº†ï¼");
    showView('view-start');
  }

  async function loginAction() {
    const name = document.getElementById('login-name').value;
    const pass = document.getElementById('login-pass').value;
    await syncFromCloud();
    const g = allData[name];
    if(g && g.gPass === pass) {
      currentGroup = g;
      document.getElementById('group-title').innerText = name + " ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼";
      renderUI();
      showView('view-calendar');
    } else { alert("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—"); }
  }

  async function addTask() {
    const title = document.getElementById('t-title').value;
    const date = document.getElementById('t-date').value;
    const delPass = document.getElementById('t-delpass').value;
    if(!title || !date || !delPass) return alert("å…¥åŠ›ã—ã¦ãã ã•ã„");
    await syncFromCloud();
    allData[currentGroup.name].tasks.push({ id: Date.now(), title, date, delPass });
    await syncToCloud();
    currentGroup = allData[currentGroup.name];
    renderUI();
  }

  function renderUI() {
    const grid = document.getElementById('cal-grid');
    grid.innerHTML = '<div class="cal-label">æ—¥</div><div class="cal-label">æœˆ</div><div class="cal-label">ç«</div><div class="cal-label">æ°´</div><div class="cal-label">æœ¨</div><div class="cal-label">é‡‘</div><div class="cal-label">åœŸ</div>';
    for(let i=1; i<=31; i++) grid.innerHTML += `<div class="cal-day" id="cal-day-${i}">${i}</div>`;
    const list = document.getElementById('task-list');
    list.innerHTML = "";
    currentGroup.tasks.forEach(t => {
      list.innerHTML += `<div class="task">${t.date}: <b>${t.title}</b></div>`;
      const d = new Date(t.date);
      const day = document.getElementById('cal-day-'+d.getDate());
      if(day) day.innerHTML += `<div class="has-task-mark"></div>`;
    });
  }

  function showView(id) {
    document.querySelectorAll('body > div').forEach(v => v.classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
  }

  syncFromCloud();
</script>
</body>
</html>
